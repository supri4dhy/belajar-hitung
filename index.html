<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petualangan Angka Ajaib</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka One', cursive;
            touch-action: none;
        }
        .fruit {
            width: 50px;
            height: 50px;
            cursor: move;
            user-select: none;
            transition: transform 0.2s ease;
        }
        .dragging {
            opacity: 0.5;
            transform: scale(1.2);
            z-index: 1000;
        }
        .drop-zone {
            transition: background-color 0.3s, border-color 0.3s;
        }
        .drag-over {
            background-color: #c8e6c9 !important;
            border-color: #4caf50 !important;
        }
        #disposal-area.drag-over {
             background-color: #fecaca !important;
             border-color: #ef4444 !important;
        }
        .menu-button {
            transition: transform 0.2s ease-in-out;
        }
        .menu-button:hover {
            transform: scale(1.05);
        }
        #drawing-canvas {
            border: 3px solid #cbd5e1;
            border-radius: 0.75rem;
            cursor: crosshair;
            touch-action: none;
        }
        .speaker-button {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .speaker-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-blue-100 flex items-center justify-center min-h-screen p-2 lg:p-4">

    <div id="main-container" class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl p-4 md:p-6 text-center">
        
        <div id="menu-screen">
            <h1 class="text-3xl md:text-5xl text-blue-600 mb-8">Petualangan Angka Ajaib</h1>
            <h2 class="text-xl md:text-2xl text-gray-700 mb-6">Pilih permainan:</h2>
            <div class="flex flex-col items-center gap-6">
                <button id="btn-penjumlahan" class="menu-button w-full max-w-xs px-6 py-4 bg-yellow-400 hover:bg-yellow-500 text-white font-bold rounded-xl shadow-lg text-2xl md:text-3xl">Penjumlahan (+)</button>
                <button id="btn-pengurangan" class="menu-button w-full max-w-xs px-6 py-4 bg-pink-400 hover:bg-pink-500 text-white font-bold rounded-xl shadow-lg text-2xl md:text-3xl">Pengurangan (-)</button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="w-full flex justify-between items-center mb-2">
                 <h1 class="text-xl md:text-2xl text-blue-600" id="game-title"></h1>
                 <button id="btn-back" class="text-sm text-gray-500 hover:text-blue-600 px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200">‚Äπ Kembali</button>
            </div>
            
            <div class="flex flex-col lg:flex-row lg:gap-6 lg:items-start">
                <div class="lg:w-1/2 flex flex-col">
                    <div id="problem-area" class="bg-gray-100 rounded-lg p-3 mb-4 text-3xl md:text-5xl text-gray-700 flex justify-center items-center gap-2 md:gap-4">
                        <span id="num1"></span>
                        <span id="operator"></span>
                        <span id="num2"></span>
                        <span>=</span>
                        <span id="answer-box" class="bg-white w-20 h-20 md:w-24 md:h-24 rounded-lg flex items-center justify-center shadow-inner text-gray-400">?</span>
                        <button id="btn-narrate" class="speaker-button">üîä</button>
                    </div>
                    
                    <div id="workspace" class="flex flex-col gap-4 min-h-[250px]">
                        <div id="source-area" class="grid grid-cols-2 gap-2">
                            <div id="source1" class="drop-zone bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg p-2 min-h-[120px] flex flex-wrap gap-1 justify-center items-center"></div>
                            <div id="source2" class="drop-zone bg-green-50 border-2 border-dashed border-green-300 rounded-lg p-2 min-h-[120px] flex flex-wrap gap-1 justify-center items-center"></div>
                        </div>
                        
                        <div id="target-area" class="flex justify-center items-center flex-col">
                             <h2 id="instruction" class="text-lg md:text-xl text-gray-600 mb-2"></h2>
                             <div id="basket" class="drop-zone w-full bg-orange-100 border-4 border-dashed border-orange-400 rounded-2xl p-2 min-h-[150px] flex flex-wrap gap-1 justify-center items-start"></div>
                        </div>

                        <div id="disposal-wrapper" class="hidden mt-2">
                            <div id="disposal-area" class="drop-zone w-full bg-red-100 border-4 border-dashed border-red-400 rounded-2xl p-2 min-h-[120px] flex flex-wrap gap-1 justify-center items-center">
                                <span class="text-4xl text-red-500 pointer-events-none">üóëÔ∏è Buang ke sini</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:w-1/2 flex flex-col items-center mt-6 lg:mt-0">
                    <div id="drawing-area" class="w-full flex flex-col items-center">
                        <h3 id="drawing-instruction" class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Sekarang, coba tulis jawabannya!</h3>
                        <canvas id="drawing-canvas" width="300" height="150"></canvas>
                        <div class="flex justify-center gap-4 mt-3">
                             <button id="btn-check" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-lg text-lg md:text-xl">Cek Jawaban</button>
                             <button id="btn-clear-canvas" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg shadow-lg text-lg md:text-xl">Hapus</button>
                        </div>
                    </div>

                    <div class="mt-4 flex flex-col items-center justify-center gap-4 w-full">
                        <div id="feedback" class="text-xl text-center md:text-2xl font-bold h-16 flex items-center justify-center"></div>
                        <button id="btn-new" class="w-full max-w-xs md:w-auto px-8 py-4 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-lg shadow-lg text-xl md:text-2xl">Soal Baru</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const mainContainer = document.getElementById('main-container');
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const btnPenjumlahan = document.getElementById('btn-penjumlahan');
        const btnPengurangan = document.getElementById('btn-pengurangan');
        const btnBack = document.getElementById('btn-back');
        const gameTitleEl = document.getElementById('game-title');
        const num1El = document.getElementById('num1');
        const num2El = document.getElementById('num2');
        const operatorEl = document.getElementById('operator');
        const answerBoxEl = document.getElementById('answer-box');
        const sourceArea = document.getElementById('source-area');
        const source1El = document.getElementById('source1');
        const source2El = document.getElementById('source2');
        const basketEl = document.getElementById('basket');
        const disposalWrapper = document.getElementById('disposal-wrapper');
        const disposalArea = document.getElementById('disposal-area');
        const feedbackEl = document.getElementById('feedback');
        const instructionEl = document.getElementById('instruction');
        const drawingInstructionEl = document.getElementById('drawing-instruction');
        const btnCheck = document.getElementById('btn-check');
        const btnNew = document.getElementById('btn-new');
        const btnClearCanvas = document.getElementById('btn-clear-canvas');
        const btnNarrate = document.getElementById('btn-narrate');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');

        let currentMode = 'penjumlahan';
        let number1, number2, correctAnswer;
        const fruits = ['üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçë'];
        let currentNarration = '';

        let sfxInitialized = false;
        let synth, correctSynth, incorrectSynth;
        async function initSfx() {
            if (sfxInitialized || typeof Tone === 'undefined') return;
            await Tone.start();
            console.log("Audio context started");
            synth = new Tone.Synth({ volume: -8 }).toDestination();
            correctSynth = new Tone.PolySynth(Tone.Synth, { volume: -8 }).toDestination();
            incorrectSynth = new Tone.Synth({ oscillator: { type: 'square' }, volume: -12 }).toDestination();
            sfxInitialized = true;
        }
        function playSfx(type) {
            if (!sfxInitialized) return;
            try {
                const now = Tone.now();
                if (type === 'correct') correctSynth.triggerAttackRelease(['C4', 'E4', 'G4'], '8n', now);
                else if (type === 'incorrect') incorrectSynth.triggerAttackRelease('A2', '8n', now);
                else if (type === 'click') synth.triggerAttackRelease('C5', '16n', now);
                else if (type === 'drop') synth.triggerAttackRelease('G4', '16n', now);
            } catch (error) { console.error("Error playing sound:", error); }
        }

        // --- Logika Narasi Suara dengan Pemilihan Suara yang Diperbarui ---
        let indonesianVoice = null;
        let voicePromise = null;

        function getAvailableVoices() {
            if (!voicePromise) {
                voicePromise = new Promise(resolve => {
                    if (!('speechSynthesis' in window)) {
                        resolve([]);
                        return;
                    }
                    let voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                        return;
                    }
                    speechSynthesis.onvoiceschanged = () => {
                        voices = speechSynthesis.getVoices();
                        resolve(voices);
                    };
                });
            }
            return voicePromise;
        }

        async function initializeVoice() {
            if (indonesianVoice) return;
            const voices = await getAvailableVoices();
            // Coba cari suara wanita berbahasa Indonesia dengan kriteria lebih luas
            indonesianVoice = voices.find(voice => voice.lang === 'id-ID' && /female|wanita|perempuan/i.test(voice.name)) 
                              || voices.find(voice => voice.lang === 'id-ID'); // Fallback ke suara Indonesia manapun
            
            if (indonesianVoice) {
                console.log("Menggunakan suara:", indonesianVoice.name);
            } else {
                console.warn("Suara Bahasa Indonesia tidak ditemukan, akan menggunakan suara default browser.");
            }
        }
        
        async function speak(text) {
            if (!('speechSynthesis' in window)) {
                console.error('Browser tidak mendukung Text-to-Speech.');
                return;
            }
            // Pastikan kita sudah mencoba mencari suara terbaik
            await initializeVoice();
            
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            utterance.rate = 0.9;
            if (indonesianVoice) {
                utterance.voice = indonesianVoice;
            }
            speechSynthesis.speak(utterance);
        }
        
        let isDrawing = false, lastX = 0, lastY = 0;
        function getMousePos(canvasDom, e) { const rect = canvasDom.getBoundingClientRect(); return { x: e.clientX - rect.left, y: e.clientY - rect.top }; }
        function getTouchPos(canvasDom, e) { const rect = canvasDom.getBoundingClientRect(); return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top }; }
        function startDrawing(e) { e.preventDefault(); isDrawing = true; let pos = e.touches ? getTouchPos(canvas, e) : getMousePos(canvas, e);[lastX, lastY] = [pos.x, pos.y]; }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); let pos = e.touches ? getTouchPos(canvas, e) : getMousePos(canvas, e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke();[lastX, lastY] = [pos.x, pos.y]; }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function setupCanvas() {
            ctx.strokeStyle = '#333'; ctx.lineWidth = 8; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
            canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', stopDrawing);
        }

        function generateProblem() {
            feedbackEl.textContent = '';
            answerBoxEl.textContent = '?';
            answerBoxEl.classList.remove('text-green-500', 'text-red-500');
            basketEl.innerHTML = ''; source1El.innerHTML = ''; source2El.innerHTML = ''; disposalArea.innerHTML = '<span class="text-4xl text-red-500 pointer-events-none">üóëÔ∏è Buang ke sini</span>';
            drawingInstructionEl.textContent = 'Sekarang, coba tulis jawabannya!';
            clearCanvas();
            number1 = Math.floor(Math.random() * 9) + 1;
            number2 = Math.floor(Math.random() * 9) + 1;
            const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];

            if (currentMode === 'penjumlahan') {
                if(number1 + number2 > 10) {
                    number2 = Math.max(1, Math.floor(Math.random() * (10 - number1)));
                }
                sourceArea.classList.remove('hidden');
                disposalWrapper.classList.add('hidden');
                correctAnswer = number1 + number2; operatorEl.textContent = '+'; gameTitleEl.textContent = 'Penjumlahan';
                instructionEl.textContent = `Ayo gabungkan buahnya!`;
                currentNarration = `${number1} ditambah ${number2} sama dengan berapa?`;
                for (let i = 0; i < number1; i++) source1El.appendChild(createFruit(randomFruit, `fruit-s1-${i}`));
                for (let i = 0; i < number2; i++) source2El.appendChild(createFruit(randomFruit, `fruit-s2-${i}`));
            } else { 
                sourceArea.classList.add('hidden');
                disposalWrapper.classList.remove('hidden');
                if (number1 < number2) [number1, number2] = [number2, number1];
                correctAnswer = number1 - number2; operatorEl.textContent = '-'; gameTitleEl.textContent = 'Pengurangan';
                instructionEl.textContent = `Ayo ambil ${number2} buah dari keranjang!`;
                currentNarration = `${number1} dikurang ${number2} sama dengan berapa?`;
                for (let i = 0; i < number1; i++) basketEl.appendChild(createFruit(randomFruit, `fruit-b-${i}`));
            }
            num1El.textContent = number1; num2El.textContent = number2;
            setTimeout(() => speak(currentNarration), 500);
        }

        function createFruit(emoji, id) {
            const fruitEl = document.createElement('div');
            fruitEl.textContent = emoji; fruitEl.id = id; fruitEl.className = 'fruit text-4xl md:text-5xl'; fruitEl.draggable = true;
            fruitEl.addEventListener('dragstart', handleDragStart); fruitEl.addEventListener('dragend', handleDragEnd);
            return fruitEl;
        }

        function checkAnswer() {
            playSfx('click');
            const userAnswer = basketEl.children.length;
            let feedbackText;
            if (userAnswer === correctAnswer) {
                playSfx('correct');
                feedbackText = `Benar! Jawabannya adalah ${correctAnswer}. Hebat!`;
                feedbackEl.innerHTML = `Benar! Jawabannya adalah ${correctAnswer} üéâ`;
                feedbackEl.className = 'text-xl text-center md:text-2xl font-bold h-16 flex items-center justify-center text-green-500';
                answerBoxEl.textContent = correctAnswer;
                answerBoxEl.classList.add('text-green-500');
                answerBoxEl.classList.remove('text-red-500', 'text-gray-400');
                drawingInstructionEl.textContent = 'Bagus! Bandingkan tulisanmu.';
            } else {
                playSfx('incorrect');
                feedbackText = 'Hmm, jumlah buahnya belum pas. Coba lagi yuk!';
                feedbackEl.textContent = 'Jumlah buahnya belum pas, coba lagi yuk!';
                feedbackEl.className = 'text-xl text-center md:text-2xl font-bold h-16 flex items-center justify-center text-red-500';
                answerBoxEl.textContent = '?';
                answerBoxEl.classList.add('text-red-500');
                answerBoxEl.classList.remove('text-green-500', 'text-gray-400');
            }
            speak(feedbackText);
        }

        function handleDragStart(e) { e.dataTransfer.setData('text/plain', e.target.id); setTimeout(() => e.target.classList.add('dragging'), 0); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); }
        function setupDropZones() {
            const dropZones = [basketEl, source1El, source2El, disposalArea];
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => { zone.classList.remove('drag-over'); });
                zone.addEventListener('drop', e => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const id = e.dataTransfer.getData('text/plain'); const draggable = document.getElementById(id);
                    if (draggable) {
                        playSfx('drop');
                        if (zone.id === 'disposal-area' && zone.children.length === 1 && zone.children[0].tagName === 'SPAN') {
                            zone.innerHTML = '';
                        }
                        zone.appendChild(draggable);
                    }
                });
            });
        }
        
        function startGame() {
            menuScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            generateProblem();
        }
        
        btnPenjumlahan.addEventListener('click', () => { playSfx('click'); currentMode = 'penjumlahan'; startGame(); });
        btnPengurangan.addEventListener('click', () => { playSfx('click'); currentMode = 'pengurangan'; startGame(); });
        btnCheck.addEventListener('click', checkAnswer);
        btnNew.addEventListener('click', () => { playSfx('click'); generateProblem(); });
        btnClearCanvas.addEventListener('click', () => { playSfx('click'); clearCanvas(); });
        btnBack.addEventListener('click', () => {
            playSfx('click');
            speechSynthesis.cancel();
            gameScreen.classList.add('hidden');
            menuScreen.classList.remove('hidden');
        });
        btnNarrate.addEventListener('click', () => {
            speak(currentNarration);
        });

        window.addEventListener('DOMContentLoaded', () => {
            setupDropZones();
            setupCanvas();
            menuScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            mainContainer.addEventListener('click', () => {
                initSfx();
                initializeVoice();
            }, { once: true });
        });

    </script>
</body>
</html>
